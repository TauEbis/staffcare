<h1>Shift Schedule for <%= schedule_date_span(@schedule) %></h1>

<div class="pull-right">
  <span class="label label-default"><%= @schedule.state.to_s.humanize %></span><br>
  <% if @schedule.draft? -%>
    <%= link_to 'Request approvals', schedule_path(@schedule, schedule: {state: 'active'}), method: :patch, class: 'btn btn-success' %>
  <% end -%>

  <% if @schedule.active? -%>
    <% prefix = current_user.admin? ? 'Force ' : '' %>
    <% btn_class = current_user.admin? ? 'btn-default ' : 'btn-success' %>

    <% if policy(@schedule).update? -%>
      <%= link_to 'Return to Draft', schedule_path(@schedule, schedule: {state: 'draft'}), method: :patch, class: 'btn btn-default' %>
      <% if LocationPlan.collective_state(@schedule.location_plans) == 'approved' -%>
        <%= link_to 'Publish', schedule_path(@schedule, schedule: {state: 'published'}), method: :patch, class: 'btn btn-primary' %>
      <% end -%>
    <% end -%>
    <% if policy(@zone).approve? -%>
      <% if LocationPlan.collective_state(@location_plans) == 'pending' -%>
        <%= link_to "#{prefix} Approve entire zone", approve_location_plans_path(location_plan_ids: @location_plans.map(&:to_param)), method: :post, class: "btn #{btn_class}" %>
      <% else -%>
        <%= link_to "#{prefix} Un-Approve entire zone", approve_location_plans_path(location_plan_ids: @location_plans.map(&:to_param), reject: true), method: :post, class: 'btn btn-default' %>
      <% end -%>
    <% end -%>
  <% end -%>

  <% if @schedule.published? -%>
    <%= link_to 'Un-Publish', schedule_path(@schedule, schedule: {state: 'active'}), method: :patch, class: 'btn btn-default' %>
  <% end -%>
</div>

<% unless @schedule.complete? -%>
  <% jid = @schedule.optimizer_job_id -%>
  <div class="alert alert-info" role="alert">
    Status: <%= Sidekiq::Status::status(jid).to_s.humanize %> - <%= Sidekiq::Status::message jid %>
    <%# Sidekiq::Status::at jid %>
    <%# Sidekiq::Status::pct_complete %>
    <%# Sidekiq::Status::total %>
  </div>
<% end -%>

<div class="row">
  <ul id="zone-tabs" class="nav nav-pills">
    <% @zones.each do |zone| %>
      <li class="<%= 'active' if zone.id == @zone.id %>"><a href="<%= schedule_location_plans_path(@schedule, zone_id: zone.id) %>"><%= zone.name %></a></li>
    <% end %>
  </ul>
</div>

<br>

<% if @location_plan %>
  <div class="row">
    <ul id="location-tabs" class="nav nav-pills">
      <% @location_plans.each do |location| %>
        <li class="<%= 'active' if location.id == @location_plan.id %>"><a href="<%= location_plan_path(location) %>"><%= location.name %></a></li>
      <% end %>
    </ul>
  </div>
<% end %>

<br><br>
